<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CowCatcher AI - Live Feed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h1 class="text-center mb-0">ðŸ“¹ Live Camera Feed</h1>
                <p class="text-center">{{ config.camera_name }}</p>
            </div>
            
            <div class="card-body">
                <div class="bg-dark rounded p-3 mb-4">
                    {% if config.developer_mode and config.use_video_file and config.video_file_path %}
                    <div class="alert alert-info">
                        <strong>Developer Mode:</strong> Using video file: {{ config.video_file_path }}
                    </div>
                    {% endif %}
                    
                    <!-- Video stream container -->
                    <div id="streamContainer" style="display: none;">
                        <img id="videoStream" src="/video_feed" class="img-fluid rounded" 
                             onerror="handleStreamError()" onload="handleStreamLoad()">
                    </div>
                    
                    <!-- Loading indicator -->
                    <div id="loadingContainer" class="text-center text-light py-5">
                        <h3>ðŸ“¹ Connecting to Stream...</h3>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3">Please wait while we establish connection to the camera feed.</p>
                    </div>
                    
                    <!-- Error/fallback container -->
                    <div id="errorContainer" class="text-center text-light py-5" style="display: none;">
                        <h3>ðŸ“¹ Stream Unavailable</h3>
                        <p class="text-muted" id="errorMessage">
                            Unable to connect to the video stream. This could be due to:
                        </p>
                        <ul class="text-muted text-start">
                            <li>Camera is offline or unreachable</li>
                            <li>Invalid RTSP URL configuration</li>
                            <li>Network connectivity issues</li>
                            <li>Authentication problems</li>
                        </ul>
                        <p class="mt-3">
                            <strong>Current Source:</strong> 
                            <span id="currentSource">
                                {% if config.developer_mode and config.use_video_file %}
                                {{ config.video_file_path }}
                                {% else %}
                                {{ config.rtsp_url }}
                                {% endif %}
                            </span>
                        </p>
                        <button class="btn btn-outline-primary mt-3" onclick="retryStream()">
                            ðŸ”„ Retry Connection
                        </button>
                        <p class="text-muted mt-3">
                            <small>For external access, use VLC or another RTSP client with the configured camera URL.</small>
                        </p>
                    </div>
                </div>
                
                <div class="alert alert-info" id="streamInfo" style="display: none;">
                    <strong>Live Stream Active:</strong> You are viewing a real-time feed from your camera. 
                    This stream is processed and optimized for web viewing with reduced resolution to improve performance.
                </div>
                
                <div class="alert alert-warning" id="streamWarning" style="display: none;">
                    <strong>Stream Issues:</strong> The video stream is experiencing connectivity issues. 
                    The CowCatcher detection system may still be running in the background using the configured source.
                </div>
                
                <div class="text-center mt-4">
                    <a href="/" class="btn btn-primary">Back to Menu</a>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let retryCount = 0;
        const maxRetries = 3;
        let retryTimeout;
        
        // Check stream status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkStreamStatus();
        });
        
        function checkStreamStatus() {
            fetch('/stream_status')
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        // Update current source display
                        document.getElementById('currentSource').textContent = data.source;
                        
                        // Try to load the stream
                        showLoadingState();
                        loadStream();
                    } else {
                        showErrorState('No video source configured');
                    }
                })
                .catch(error => {
                    console.error('Error checking stream status:', error);
                    showErrorState('Unable to check stream status');
                });
        }
        
        function loadStream() {
            const videoStream = document.getElementById('videoStream');
            
            // Add timestamp to prevent caching issues
            const timestamp = new Date().getTime();
            videoStream.src = `/video_feed?t=${timestamp}`;
        }
        
        function handleStreamLoad() {
            console.log('Stream loaded successfully');
            retryCount = 0;
            showStreamState();
        }
        
        function handleStreamError() {
            console.log('Stream error occurred, retry count:', retryCount);
            
            if (retryCount < maxRetries) {
                retryCount++;
                showLoadingState();
                
                // Retry after delay
                retryTimeout = setTimeout(() => {
                    console.log('Retrying stream connection...');
                    loadStream();
                }, 2000 * retryCount); // Exponential backoff
            } else {
                showErrorState('Failed to connect to video stream after multiple attempts');
            }
        }
        
        function retryStream() {
            retryCount = 0;
            clearTimeout(retryTimeout);
            showLoadingState();
            setTimeout(loadStream, 1000);
        }
        
        function showLoadingState() {
            document.getElementById('streamContainer').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'block';
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('streamInfo').style.display = 'none';
            document.getElementById('streamWarning').style.display = 'none';
        }
        
        function showStreamState() {
            document.getElementById('streamContainer').style.display = 'block';
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('streamInfo').style.display = 'block';
            document.getElementById('streamWarning').style.display = 'none';
        }
        
        function showErrorState(message) {
            document.getElementById('streamContainer').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('streamInfo').style.display = 'none';
            document.getElementById('streamWarning').style.display = 'block';
            
            if (message) {
                document.getElementById('errorMessage').textContent = message;
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            clearTimeout(retryTimeout);
        });
    </script>
</body>
</html>
