<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CowCatcher AI - Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h1 class="text-center mb-0">‚öôÔ∏è Settings</h1>
                <p class="text-center">Configuration Panel</p>
            </div>
            
            <div class="card-body">
                <div id="status-message"></div>
                
                <form method="POST" action="/save" id="config-form">
                <!-- Camera Configuration -->
                <h2 class="border-bottom pb-2 mb-4">üì∑ Camera Configuration</h2>
                
                <div class="mb-3">
                    <label for="camera_name" class="form-label">Camera Name</label>
                    <input type="text" class="form-control" id="camera_name" name="camera_name" 
                           value="{{ config.camera_name }}" required>
                    <div class="form-text">Friendly name for this camera (shown in Telegram messages)</div>
                </div>
                
                <div class="mb-3">
                    <label for="rtsp_url" class="form-label">RTSP URL</label>
                    <input type="text" class="form-control" id="rtsp_url" name="rtsp_url" 
                           value="{{ config.rtsp_url }}" 
                           placeholder="rtsp://admin:password@192.168.1.100:554/h264Preview_01_sub" required>
                    <div class="form-text">Format: rtsp://username:password@ip_address:port/stream_path</div>
                </div>
                
                <div class="mb-3">
                    <label for="model_path" class="form-label">Current AI Model</label>
                    <input type="text" class="form-control" id="model_path" name="model_path" 
                           value="{{ config.model_path }}" readonly>
                    <div class="form-text">Current YOLO model in use</div>
                </div>
                
                <div class="mb-3">
                    <label for="model_file" class="form-label">Upload New AI Model</label>
                    <input type="file" class="form-control" id="model_file" accept=".pt" onchange="uploadModel(this)">
                    <div class="form-text">Upload a new .pt model file to replace the current one</div>
                    <div id="upload-status"></div>
                </div>
                
                <!-- Developer Mode -->
                <h2 class="border-bottom pb-2 mb-4 mt-5">üõ†Ô∏è Developer Mode</h2>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="developer_mode" name="developer_mode" 
                           {% if config.developer_mode %}checked{% endif %} onchange="toggleDeveloperOptions()">
                    <label class="form-check-label" for="developer_mode">Enable Developer Mode</label>
                </div>
                
                <div id="developer-options">
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="use_video_file" name="use_video_file" 
                               {% if config.use_video_file %}checked{% endif %} onchange="toggleVideoFileOptions()">
                        <label class="form-check-label" for="use_video_file">Use Video File Instead of RTSP</label>
                    </div>
                    
                    <div id="video-file-options">
                        <div class="mb-3">
                            <label for="video_file" class="form-label">Upload Video File</label>
                            <input type="file" class="form-control" id="video_file" accept=".mp4,.avi,.mov,.mkv" onchange="uploadVideo(this)">
                            <div class="form-text">Upload a video file for testing (mp4, avi, mov, mkv)</div>
                            <div id="video-upload-status"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="video_file_path" class="form-label">Video File Path</label>
                            <input type="text" class="form-control" id="video_file_path" name="video_file_path" 
                                   value="{{ config.video_file_path }}" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- Telegram Configuration -->
                <h2 class="border-bottom pb-2 mb-4 mt-5">üì± Telegram Configuration</h2>
                
                <div class="mb-3">
                    <label for="telegram_bot_token" class="form-label">Telegram Bot Token</label>
                    <input type="password" class="form-control" id="telegram_bot_token" name="telegram_bot_token" 
                           value="{{ config.telegram_bot_token }}" 
                           placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz" required>
                    <div class="form-text">Get from @BotFather on Telegram</div>
                </div>
                
                <div class="mb-3">
                    <label for="telegram_chat_ids" class="form-label">Telegram Chat IDs</label>
                    <input type="text" class="form-control" id="telegram_chat_ids" name="telegram_chat_ids" 
                           value="{{ config.telegram_chat_ids }}" 
                           placeholder="123456789,987654321" required>
                    <div class="form-text">Comma-separated list of chat IDs (get from @userinfobot)</div>
                </div>
                
                <!-- Detection Thresholds -->
                <h2 class="border-bottom pb-2 mb-4 mt-5">üéØ Detection Thresholds</h2>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="save_threshold" class="form-label">Save Threshold ({{ config.save_threshold }})</label>
                        <input type="range" class="form-range" id="save_threshold" name="save_threshold" 
                               min="0.5" max="1.0" step="0.01" value="{{ config.save_threshold }}" 
                               oninput="this.previousElementSibling.textContent='Save Threshold (' + this.value + ')'">
                        <div class="form-text">Minimum confidence to save images</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="notify_threshold" class="form-label">Notification Threshold ({{ config.notify_threshold }})</label>
                        <input type="range" class="form-range" id="notify_threshold" name="notify_threshold" 
                               min="0.5" max="1.0" step="0.01" value="{{ config.notify_threshold }}"
                               oninput="this.previousElementSibling.textContent='Notification Threshold (' + this.value + ')'">
                        <div class="form-text">Minimum confidence to send notifications</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="peak_detection_threshold" class="form-label">Peak Detection Threshold ({{ config.peak_detection_threshold }})</label>
                        <input type="range" class="form-range" id="peak_detection_threshold" name="peak_detection_threshold" 
                               min="0.5" max="1.0" step="0.01" value="{{ config.peak_detection_threshold }}"
                               oninput="this.previousElementSibling.textContent='Peak Detection Threshold (' + this.value + ')'">
                        <div class="form-text">Threshold for peak detection</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="min_high_confidence_detections" class="form-label">Min High Confidence Detections</label>
                        <input type="number" class="form-control" id="min_high_confidence_detections" name="min_high_confidence_detections" 
                               value="{{ config.min_high_confidence_detections }}" min="1" max="20" required>
                        <div class="form-text">Required detections above notify threshold</div>
                    </div>
                </div>
                
                <!-- Collection Settings -->
                <h2 class="border-bottom pb-2 mb-4 mt-5">‚è±Ô∏è Collection Settings</h2>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="collection_time" class="form-label">Max Collection Time (seconds)</label>
                        <input type="number" class="form-control" id="collection_time" name="collection_time" 
                               value="{{ config.collection_time }}" min="1" max="300" required>
                        <div class="form-text">Maximum time to collect screenshots</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="min_collection_time" class="form-label">Min Collection Time (seconds)</label>
                        <input type="number" class="form-control" id="min_collection_time" name="min_collection_time" 
                               value="{{ config.min_collection_time }}" min="1" max="60" required>
                        <div class="form-text">Minimum time to collect</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="inactivity_stop_time" class="form-label">Inactivity Stop Time (seconds)</label>
                        <input type="number" class="form-control" id="inactivity_stop_time" name="inactivity_stop_time" 
                               value="{{ config.inactivity_stop_time }}" min="1" max="60" required>
                        <div class="form-text">Stop collection after inactivity</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="cooldown_period" class="form-label">Cooldown Period (seconds)</label>
                        <input type="number" class="form-control" id="cooldown_period" name="cooldown_period" 
                               value="{{ config.cooldown_period }}" min="1" max="300" required>
                        <div class="form-text">Time between consecutive notifications</div>
                    </div>
                </div>
                
                <!-- Notification Settings -->
                <h2 class="border-bottom pb-2 mb-4 mt-5">üì¢ Notification Settings</h2>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="max_screenshots" class="form-label">Max Screenshots</label>
                        <input type="number" class="form-control" id="max_screenshots" name="max_screenshots" 
                               value="{{ config.max_screenshots }}" min="1" max="10" required>
                        <div class="form-text">Number of photos per notification</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="sound_every_n_notifications" class="form-label">Sound Every N Notifications</label>
                        <input type="number" class="form-control" id="sound_every_n_notifications" name="sound_every_n_notifications" 
                               value="{{ config.sound_every_n_notifications }}" min="1" max="20" required>
                        <div class="form-text">Play sound every N notifications</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="max_detections_to_keep" class="form-label">Max Detections to Keep</label>
                        <input type="number" class="form-control" id="max_detections_to_keep" name="max_detections_to_keep" 
                               value="{{ config.max_detections_to_keep }}" min="10" max="10000" required>
                        <div class="form-text">Maximum number of detection images to store</div>
                    </div>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="send_annotated_images" name="send_annotated_images" 
                           {% if config.send_annotated_images %}checked{% endif %}>
                    <label class="form-check-label" for="send_annotated_images">Send Annotated Images (with bounding boxes)</label>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="show_live_feed" name="show_live_feed" 
                           {% if config.show_live_feed %}checked{% endif %}>
                    <label class="form-check-label" for="show_live_feed">Show Live Feed (requires display)</label>
                </div>
                
                <!-- Submit Buttons -->
                <div class="d-flex gap-3 mt-4">
                    <button type="submit" class="btn btn-primary flex-fill">Save Configuration</button>
                    <a href="/" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleDeveloperOptions() {
            const devMode = document.getElementById('developer_mode').checked;
            document.getElementById('developer-options').style.display = devMode ? 'block' : 'none';
            if (!devMode) {
                document.getElementById('use_video_file').checked = false;
                toggleVideoFileOptions();
            }
        }
        
        function toggleVideoFileOptions() {
            const useVideo = document.getElementById('use_video_file').checked;
            document.getElementById('video-file-options').style.display = useVideo ? 'block' : 'none';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleDeveloperOptions();
            toggleVideoFileOptions();
        });
        
        async function uploadModel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('upload-status');
            statusDiv.innerHTML = '<div class="alert alert-info mt-2">Uploading...</div>';
            
            const formData = new FormData();
            formData.append('model_file', file);
            
            try {
                const response = await fetch('/upload_model', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '<div class="alert alert-success mt-2">‚úì Model uploaded: ' + result.filename + '</div>';
                    document.getElementById('model_path').value = result.filename;
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger mt-2">‚úó Error: ' + result.error + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger mt-2">‚úó Upload failed: ' + error.message + '</div>';
            }
        }
        
        async function uploadVideo(input) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('video-upload-status');
            statusDiv.innerHTML = '<div class="alert alert-info mt-2">Uploading...</div>';
            
            const formData = new FormData();
            formData.append('video_file', file);
            
            try {
                const response = await fetch('/upload_video', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '<div class="alert alert-success mt-2">‚úì Video uploaded: ' + result.filename + '</div>';
                    document.getElementById('video_file_path').value = result.path;
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger mt-2">‚úó Error: ' + result.error + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger mt-2">‚úó Upload failed: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>
